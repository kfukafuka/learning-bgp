# 概要
ルーティングプロトコルであるBGP(Border Gateway Protocol)に関して調べたことや  
試してみたことなどが記載されている
# ルーティングに関する簡単なおさらい
## [IGPとEGP]
* IGP(Interior Gateway Protocol)
    * AS内部で使用される
    * OSPFやRIPなど
* EGP(Exterior Gateway Protocol)
    * AS間で使用される
    * BGP

## [AS](https://www.nic.ad.jp/ja/basics/terms/as.html)
* インターネットの構成単位であり、各々のASはそれぞれの運用ポリシーを持っている
* 一般的にASの多くはISP
* 自律システムと訳すことができる
* 一つの運用ポリシーを持ったネットワークの塊
* 各々のASにはAS番号という、世界で一意な番号を持つ
    * https://www.nic.ad.jp/ja/ip/as-numbers.txt
* AS番号はICANNという組織によって、RIR（Reginal Internet Registry）にブロック単位で割り当てしている。
    * 日本ではJPINICやAPNICがAS番号の割り当てを管理している。
* AS番号は大きく2つに分類することができる

|AS番号|AS番号の範囲|用途|
|---|---|---|
|グローバルAS番号|1-64511|インターネット全体で一意のAS番号|
|プライベートAS番号(後ろから1024)|64512-65535|組織内部で自由に使用できるAS番号。AS外に情報を流してはだめ|    
* [4バイトAS番号](https://www.nic.ad.jp/ja/basics/terms/as4bytes.html)
    * AS番号を従来の2バイトから4バイトに拡張したもの
    * 2バイトのAS番号が枯渇するとみられており仕様策定
    * 4バイトのAS番号は2バイトずつピリオドで区切り、それぞれを10進数で表す
    * [0.0]から[65535.65535]
    
## ロンゲストマッチ
マッチするネットワークアドレスが複数ある場合には、通常プレフィックス長(マスク長)が  
長い方のネットワークアドレスを選択し、それに従って転送される

## ループバックインターフェース
ループバックインターフェースは物理インターフェースに依存しない論理インターフェースで、  
ルータが正常動作している限り必ず生きているインターフェース

# BGP-4
* BGPで現在使われているのはバージョン4 (RFC1771)
* パスベクターアルゴリズムという考え方を使用
* ASが持つIPアドレスとそれに付随したパス属性をBGPを設定した装置(BGPスピーカー)間で交換する
* ポリシーを反映させた経路制御が可能
    * 2回線あったときに Active/Active でつなぐのか Active/Standby でつなぐのか
* トラフィックの方向
	* 自ASから外のASに流れるトラフィック
        * 上がりトラフィック
        * 完全に制御できる
    * 外のASから自分のASに流れてくるトラフィック
        * 下りトラフィック
        * 接続先ASのポリシーとの兼ね合い
    * 両方のトラフィックを別々に制御することが可能
* CIDRによるルート集約、VLSMによるサブネット分割時の可変長マスクを実現

# eBGP と iBGP
* eBGP
    * 異なるASに属するBGPスピーカ間のBGPピア
    * AS外のBGPスピーカと経路情報のやりとりをする
    * ルータ間で直接接続している必要がある
        * BGPパケットのTTL が 1
* iBGP
    * 同一AS内部のBGPスピーカ間のBGPピア
    * eBGPで得た自分以外のASからの経路情報を、更に自分のAS内の他のBGPスピーカに伝えるときに使われる
    * 間に複数のルータがはいるような離れたBGPスピーカ間でもピアを張ることができる
        * BGPパケットのTTLが255
        * 離れた場所にいるBGPスピーカ同士がピアを張るためには、IP通信が可能である必要あり
            * iBGPのピアを張るための前提としてOSPFなどのIGPが設定されている必要がある
            * iBGPはピア先が隣ではないことが多いため、IGPを設定していないとピア先のアドレスがどこかわからない
    * 原則として、AS内のすべてのBGPスピーカとフルメッシュでピアを張っておく必要がある
        * ルートリフレクタが用いられることもある
    * 経路のループを防ぐために、あるiBGPを通してもらった経路情報を他のiBGPのピアに送ることしない

# BGP-4 での経路情報交換
* 経路情報交換にTCP(ポート番号 179)を使用する
* 情報交換するルータ同士でTCPを用いた1対1のBGPセッションを使用する
    * このセッションが確立したうえで、経路情報の交換を行う
    * BGP制御の流れ
        * TCP を利用したBGPピアを張る。
        * 隣接BGPスピーカーから経路情報をもらう
        * 受け取った経路情報をBGPテーブルに格納する。  
           パス属性の評価が行われた後にベストパスと呼ばれる最適経路が書くプレフィックスに1つ選ばれる
        * BGPピアを維持。別のピア先にベストパス情報を広報
    * 他のピアにアナウンスされる経路はベストパスとして選ばれた経路だけ
    * 経路情報のやりとりが終わったあとは、変化があった時にいつでも経路情報のやりとりができるよう
      にピアを張った状態を維持する。
    * ピアを張って経路情報をもらい、ベストパス選択をしてルーティングテーブルを作り、
      更にその情報を他のピアにアナウンスするという動作をすべてのBGPスピーカーが行う


# 交換メッセージの種類
* OPEN
    * TCPコネクションの確立後、BGPネイバーとのセッションを開始するための最初のメッセージ。
    * OPENメッセージには「バージョン、AS番号、BGPのルータID、holdtime、認証」の情報がある。
* UPDATE
    * NLRIとパス属性をやりとりする際に使用
    * BGPテーブル作成時に送信される全てのルート情報、または変更発生時に送信される
      差分のルート情報が含まれるメッセージ。
    * 送信されるルート情報には、パスアトリビュートの情報も含まれる。
* KEEPALIVE
    * BGPネイバー関係を維持するための生存確認メッセージ。Ciscoルータではデフォルトで60秒ごとに
    * KEEPALIVEメッセージが送信される。なお、BGPネイバーのダウンとみなすホールドタイムは180秒。
* NOTIFICATION
    * エラーを検出した時に通知されるメッセージ。BGPネイバーが確立できない場合や、ホールドタイムを超過した場合などにNOTIFICATIONメッセージでエラー通知を行い、BGPセッションを切断する。
* ROUTE-REFRESH
    * RFC 2918 で追加されたメッセージで、経路情報の再送信を要求するためのメッセージ

# BGPテーブルとルーティングテーブル
* OSPFのようなトポロジカルデータベースは持たない
* BGPテーブルと呼ばれるBGPで得た経路情報だけを格納するテーブルを持つ
* 全く同じ経路が複数存在することがある場合
    * 経路に付随したパス属性をもとにペストパスだけが最終的に最終的にルーティングテーブルの
      エントリとして採用されフォワーディング処理に使用される

# RIBs(Routing Information Bases)
* RFC上でのBGPテーブルの呼び名
    * BGPスピーカの内部でUPDARTEメッセージに含まれる情報を次の3つのテーブルに分けている
        * Adj-RIBｓ−In
        * Loc-RIB
        * Sdj-RIBs-Out

# BGPとOSPFの違い
## やりとりされる情報の違い
* OSPF
    * LSAと呼ばれるリンクの情報をネットワーク内に伝播させ、 自分が持っているネットワーク情報を他のルータに伝える
    * OSPFが設定されているすべてのルータが自分の持っている情報を 伝えあうことで、ネットワークのトポロジに関するDBを作成する
    * 常に最短経路で通信するために、ネットワークに障害が発生した場合などは、 その情報をすぐに他のルータに伝え、
    全ルータでトポロジの再計算を行い、ルーティングテーブルを作りなおす
* BGP
    * NLPI(宛先IPアドレスプレフィックス情報)とそれに付随するパス属性の情報がやりとりされる
    * OSPFのようなトポロジを表すDBは持たず、その経路が生きているか、死んでいるかのみを情報としてやりとりする
        * AS間で経路情報をやりとりするためのプロトコルであり、経路の存在の有無さえわかれば、
          相手のISPより内の  トポロジ情報まで把握しておく必要がないため。
    * 最適な経路選択は付随するパス属性の値に基づいて行う

## 情報交換契機の違い
* OSPF
    * ISP内で常に最新の情報を把握するために、リンクに障害が発生した場合にすぐに他のルータに伝える
    * 情報変化を検知するとOSPFが設定された全ルータで一斉にトポロジの再計算が行われ、全体のデータベースが更新される
    * 常に最適な状態を保とうとするため大規模なネットワークの場合は計算量が多くなり、ネットワークの安定性に問題になることがある
    * 30分に一度、定期的に自分の持っている経路情報をネットワーク全体に伝えて、常に最新状態に保つ
* BGP
    * 経路が消えた場合にはすぐに他のBGPスピーカに伝えられる
    * トポロジのDBはないため、経路が消えても該当の情報が削除されるだけ
    * 最適経路更新のためのデータベース全体の再計算は行われない
    * 状態変化があった場合のみ、その情報が伝えられる

# 参考文献
* [インターネットルーティング入門](https://www.amazon.co.jp/dp/B00K65T6L8/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1)
* [BGPの技術](http://www.infraexpert.com/study/study60.html)
* [インターネット1分解説](https://www.nic.ad.jp/ja/basics/terms/index.html)
* [インターネット10分講座](https://www.nic.ad.jp/ja/newsletter/10minute.html)
